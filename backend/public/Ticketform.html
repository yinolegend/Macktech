<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Ticket Form — Mack Technologies</title>
    <style>
      :root{ --brand:#0b74ff; --muted:#6b7a99 }
      body{ font-family:system-ui, -apple-system, Arial; margin:0; padding:28px; background:linear-gradient(180deg,#f7fbff,#ffffff); }
      .card{ max-width:760px; margin:24px auto; background:white; border-radius:10px; padding:20px; box-shadow:0 6px 20px rgba(11,27,60,0.06) }
      label{ display:block; margin-top:12px; color:#284060; font-weight:600 }
      input[type=text], textarea, select{ width:100%; padding:10px; margin-top:6px; border-radius:8px; border:1px solid #e6f0ff; box-sizing:border-box }
      textarea{ min-height:140px }
      .row{ display:flex; gap:12px }
      .row > *{ flex:1 }
      .actions{ margin-top:14px; display:flex; gap:8px }
      .btn{ padding:10px 14px; border-radius:8px; border:0; cursor:pointer }
      .top-button{ background:linear-gradient(180deg,#dff0ff,#cfefff); border:1px solid rgba(11,116,255,0.12); color:var(--brand); padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600 }
      .btn.primary{ background:var(--brand); color:#fff }
      .muted{ color:var(--muted); font-size:13px }
    </style>
  </head>
  <body>
    <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
        <h2>Ticket Form</h2>
        <button id="btnHomeTicketForm" class="top-button" title="Home">Home</button>
      </div>
      <p class="muted">Complete this form to create a ticket. The category dropdown matches the landing selector.</p>

      <form id="ticketForm">
        <label for="name">Name</label>
        <input id="name" name="name" type="text" placeholder="Your name or requester (will be used as requester)" />

        <label for="category">Category</label>
        <select id="category" name="category">
          <option>Software</option>
          <option>Mouse</option>
          <option>Keyboard</option>
          <option>Monitor</option>
          <option>Desktop</option>
        </select>

        <label for="description">Description</label>
        <textarea id="description" name="description" placeholder="Describe the issue or request"></textarea>

        <div class="actions">
          <button type="submit" class="btn primary">Create Ticket</button>
        </div>
      </form>

      <div id="result" style="margin-top:12px"></div>
    </div>

    <script>
      // Standalone ticket form (mostly for kiosk/QR code use). Kept tiny so any
      // teammate can adjust fields without digging into the app shell.
      const TOKEN_KEY = 'mack_token';

      // Prefill name from token-based /api/me or from query string headerless SSO can't be read from JS.
      (async function prefill(){
        try{
          const token = localStorage.getItem(TOKEN_KEY);
          if (token) {
            const res = await fetch('/api/me', { headers: { Authorization: 'Bearer ' + token } });
            if (res.ok) {
              const user = await res.json();
              if (user && user.username) document.getElementById('name').value = user.display_name || user.username;
            }
          }
        }catch(e){}

        // Apply category from query string if present
        const q = new URLSearchParams(location.search);
        const c = q.get('category');
        if (c) {
          const sel = document.getElementById('category');
          for (const opt of sel.options) if (opt.value === c) opt.selected = true;
        }
      })();

      document.getElementById('ticketForm').addEventListener('submit', async (ev)=>{
        ev.preventDefault();
        const name = document.getElementById('name').value.trim();
        const category = document.getElementById('category').value;
        const description = document.getElementById('description').value.trim();
        if (!name) return alert('Please enter your name');
        if (!description) return alert('Please add a description');

        const title = `${category} request by ${name}`;
        const payload = { title, description, requester: name };

        const headers = { 'Content-Type':'application/json' };
        const token = localStorage.getItem(TOKEN_KEY);
        if (token) headers['Authorization'] = 'Bearer ' + token;

        try{
          const res = await fetch('/api/tickets', { method:'POST', headers, body: JSON.stringify(payload) });
          const j = await res.json();
          const resultEl = document.getElementById('result');
          if (!res.ok) {
            if (res.status === 401) {
              resultEl.innerHTML = '<div style="color:#b33737">Not authenticated — please sign in or ensure SSO headers are forwarded.</div>';
            } else {
              resultEl.innerHTML = '<div style="color:#b33737">Failed: ' + (j && j.error ? j.error : 'unknown') + '</div>';
            }
            return;
          }
          resultEl.innerHTML = '<div style="color:green">Ticket created — ID: ' + (j.id || j.id === 0 ? j.id : j.id) + '</div>';
          setTimeout(()=>{ window.location.href = '/app.html#tickets'; }, 1000);
        }catch(e){
          document.getElementById('result').innerHTML = '<div style="color:#b33737">Network error</div>';
        }
      });

      // Home button on the standalone ticket form
      const btnHomeTicketForm = document.getElementById('btnHomeTicketForm');
      if (btnHomeTicketForm) btnHomeTicketForm.addEventListener('click', ()=> { window.location.href = '/'; });
    </script>
  </body>
</html>
